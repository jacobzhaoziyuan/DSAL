# PATH definition
global_path = './'
data_path = global_path + 'orgData/trainImg/'                                       # DIRECTORY TO TRAIN IMAGE
masks_path = global_path + 'orgData/trainGT/'                                       # DIRECTORY TO TRAIN MASK
val_data_path = global_path + 'orgData/valImg/'                                     # DIRECTORY TO VALIDATION IMAGE
val_masks_path = global_path + 'orgData/valGT/'                                     # DIRECTORY TO VALIDATION MASK
exp = "DSAL"                                                                        # EXPERIMENT IDENTIFIER, SHOULD CONTAIN "CRF" IF DOING POST-PROCESSING
initial_weights_path = global_path + f"{exp}/[initial_weights_name].hdf5"           # WEIGHTS PATH OF BASE MODEL
final_weights_path = global_path + f"{exp}/[output_weights_name].hdf5"              # WEIGHTS PATH OF THE LATEST MODEL
resume_on = 0                                                                       # RESUME TRAINING ON WHICH AL ITERATION?

# Data definition
img_rows = 64 * 3 # 192
img_cols = 80 * 3 # 240
lr = 1e-5
USE_BCE = False                                                                     # FALSE FOR ISIC DATASET AND TRUE FOR RSNA
z_score = False                                                                     # TRUE FOR ISIC DATASET AND FALSE FOR RSNA

nb_total = 2000
nb_train = 1600                                                                     # TOTAL NUM OF TRAINING POOL WITH ANNOTATIONS
nb_labeled = 600                                                                    # NUM OF INITIAL TRAINING POOL FOR BASE MODEL
nb_unlabeled = nb_train - nb_labeled                                                # NUM OF THE SAMPLES LEFT IN THE POOL

# AL parameters
apply_edt = True
nb_iterations = 10
nb_step_predictions = 20
nb_next_sample = 35

pseudo_epoch = 5                                                                    # ADD PSEUDO LABELS FROM THIS AL ITERATION ONWARDS
nb_pseudo_initial = 20
pseudo_rate = 20
random_inc = False                                                                  # randomly select oracle indices
simple_ranking = False	# whether select samples from pool by simply ranking the uncertainty without histogram, used in MCDropout

CONF_THRES = True     # set to a value in (0, 0.5] to activate confidence filtered query
BINS = 10             # number of historgram bins

apply_augmentation = False
nb_initial_epochs = 15
nb_active_epochs = 10
batch_size = 32 # 128

post_process = "CRF" in exp
pre_ensemble = False
DS_ASCEND = True
random_pseudo = False
CRF_SCALES = 1
USE_CRF_THRES = .98
MCDropout_DS_uncertain = False

uncertain_type = ""
if "ensemble_S" in exp:
    uncertain_type = "ensemble_S"
elif "ensemble_JS" in exp:
    uncertain_type = "ensemble_JS"
T = 5

loss_weights = [0.6, 0.3, 0.1]


# Optimized DenseCRF Hyperparams
MCRF_cfgs = [{'scords_gau': (29.929043581135517, 29.929043581135517), 'scords_bi': (28.190824981848024, 28.190824981848024), 'schan': (5.5925268179150045,), 'compat': (9.058451433313298, 9.459431949890552), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (29.863803841834088, 29.863803841834088), 'scords_bi': (27.78506470611962, 27.78506470611962), 'schan': (5.623832855248079,), 'compat': (9.088956786717441, 9.43201857707485), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (30.028292522039838, 30.028292522039838), 'scords_bi': (27.486252437447554, 27.486252437447554), 'schan': (5.584580228164012,), 'compat': (9.186176437531836, 8.928409865202788), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (30.206947133069633, 30.206947133069633), 'scords_bi': (27.023193639263056, 27.023193639263056), 'schan': (6.226787216071423,), 'compat': (8.490437567138201, 8.781030557122744), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.994977904899674, 29.994977904899674), 'scords_bi': (26.684801274518918, 26.684801274518918), 'schan': (6.7053937708341165,), 'compat': (7.453619558859368, 9.666683761254522), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.131600801601415, 30.131600801601415), 'scords_bi': (26.9646665001107, 26.9646665001107), 'schan': (6.146457711570781,), 'compat': (9.374342571756415, 8.053466129771895), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.081848225522002, 30.081848225522002), 'scords_bi': (26.838669019017747, 26.838669019017747), 'schan': (6.031365247276766,), 'compat': (10.012975060890872, 7.750982463886633), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.63227178094337, 29.63227178094337), 'scords_bi': (27.050317466433352, 27.050317466433352), 'schan': (6.313590371905832,), 'compat': (8.531610828428429, 8.65694089650029), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.272343158044606, 29.272343158044606), 'scords_bi': (26.92676208417112, 26.92676208417112), 'schan': (5.682158705235652,), 'compat': (8.699697548070306, 8.125908807461844), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.207365576592878, 30.207365576592878), 'scords_bi': (26.854739731202354, 26.854739731202354), 'schan': (6.64741451095781,), 'compat': (9.582331750398046, 7.857980647854469), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.705581073631464, 29.705581073631464), 'scords_bi': (27.749529101665356, 27.749529101665356), 'schan': (5.605832254530724,), 'compat': (8.342139851590842, 9.675169892276015), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.8035451510818, 29.8035451510818), 'scords_bi': (27.185278057762098, 27.185278057762098), 'schan': (5.810603443703405,), 'compat': (9.216870239725447, 8.075244512915136), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.87718226934411, 29.87718226934411), 'scords_bi': (27.010537800190967, 27.010537800190967), 'schan': (5.595312972246865,), 'compat': (9.241917066151556, 8.219789708125694), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.963351617487252, 29.963351617487252), 'scords_bi': (26.450307303890753, 26.450307303890753), 'schan': (5.7826549065190935,), 'compat': (9.080937968631165, 7.513592506373325), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.706641040862998, 29.706641040862998), 'scords_bi': (28.03241069144989, 28.03241069144989), 'schan': (4.9985032076072615,), 'compat': (8.76576356418372, 9.471517060573312), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (29.956637496777837, 29.956637496777837), 'scords_bi': (27.37199101314543, 27.37199101314543), 'schan': (5.402475112290278,), 'compat': (8.292061119611338, 9.183101059725015), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (29.88358405699728, 29.88358405699728), 'scords_bi': (26.285207639334075, 26.285207639334075), 'schan': (6.50678303424908,), 'compat': (9.055411480163729, 7.965756157799924), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.003572507587077, 30.003572507587077), 'scords_bi': (27.44397138158795, 27.44397138158795), 'schan': (5.4846578621422,), 'compat': (10.160657302189248, 8.633348787832782), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.938072061339117, 29.938072061339117), 'scords_bi': (26.374470145865402, 26.374470145865402), 'schan': (6.296755809107011,), 'compat': (9.209710025020511, 8.7354158281233), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (30.05779910282216, 30.05779910282216), 'scords_bi': (26.988053850383178, 26.988053850383178), 'schan': (5.975114968299675,), 'compat': (9.870490719472782, 7.776871843190308), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (28.81218863204817, 28.81218863204817), 'scords_bi': (26.798443469730792, 26.798443469730792), 'schan': (5.872905495963689,), 'compat': (8.578010859901493, 8.887329201428972), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.17593012144308, 30.17593012144308), 'scords_bi': (26.62885977464552, 26.62885977464552), 'schan': (5.507413857400258,), 'compat': (9.48597518295184, 7.961181329023175), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (30.034063363296152, 30.034063363296152), 'scords_bi': (27.26524139278994, 27.26524139278994), 'schan': (5.101273135340541,), 'compat': (8.88699711378815, 9.611209829347587), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (30.08659779971269, 30.08659779971269), 'scords_bi': (27.15193872029894, 27.15193872029894), 'schan': (5.256824508780557,), 'compat': (9.625052898279938, 7.567595806663277), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.113716238521913, 30.113716238521913), 'scords_bi': (27.182010971666923, 27.182010971666923), 'schan': (4.731486115049865,), 'compat': (10.458690424413344, 8.639597223526708), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.026960185634177, 30.026960185634177), 'scords_bi': (26.816188161343636, 26.816188161343636), 'schan': (6.253744125709329,), 'compat': (9.358321758636613, 8.15563910325958), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.426887951088293, 29.426887951088293), 'scords_bi': (26.88779352829808, 26.88779352829808), 'schan': (5.658297184213785,), 'compat': (9.102366355051128, 8.427579748148393), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.678297997372383, 29.678297997372383), 'scords_bi': (28.360680980181797, 28.360680980181797), 'schan': (5.234051360883435,), 'compat': (9.125476669849876, 9.632472818920673), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.880193983311074, 29.880193983311074), 'scords_bi': (26.895228805387305, 26.895228805387305), 'schan': (5.414605027415602,), 'compat': (9.5824493782025, 7.603032528257632), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.164829176594615, 30.164829176594615), 'scords_bi': (27.302402267642425, 27.302402267642425), 'schan': (5.658592497087685,), 'compat': (9.243174310641741, 9.088432027564027), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.208359399566096, 30.208359399566096), 'scords_bi': (27.150690398300476, 27.150690398300476), 'schan': (6.943582432161237,), 'compat': (10.203521647450767, 6.996877466009277), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.002854650801897, 30.002854650801897), 'scords_bi': (27.01140562349462, 27.01140562349462), 'schan': (5.596160987795369,), 'compat': (9.236184942450645, 7.433926558785874), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (30.081819232484563, 30.081819232484563), 'scords_bi': (27.524792493137742, 27.524792493137742), 'schan': (5.488116698151543,), 'compat': (8.925195105289088, 9.745920124326744), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.063436845823595, 30.063436845823595), 'scords_bi': (26.774494052386547, 26.774494052386547), 'schan': (5.353348908819681,), 'compat': (9.743764958563748, 8.53898447056039), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.04233187245726, 29.04233187245726), 'scords_bi': (27.39343221687039, 27.39343221687039), 'schan': (5.368634422134414,), 'compat': (8.000747712356734, 7.8107478707936355), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.2497660396653, 29.2497660396653), 'scords_bi': (27.634200563693316, 27.634200563693316), 'schan': (6.540135035839665,), 'compat': (8.248976579380484, 7.6358136305379904), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.592573299426743, 29.592573299426743), 'scords_bi': (27.62636444417714, 27.62636444417714), 'schan': (5.573059968833369,), 'compat': (9.804713723198, 9.549491802273517), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.78358582871132, 29.78358582871132), 'scords_bi': (28.02433865333358, 28.02433865333358), 'schan': (5.673512292018464,), 'compat': (7.942097982914772, 9.298637592464358), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.833957178010678, 29.833957178010678), 'scords_bi': (26.989564735936145, 26.989564735936145), 'schan': (5.492347781679933,), 'compat': (8.888455313399625, 7.777291803581083), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.355112321850704, 30.355112321850704), 'scords_bi': (27.403142396559243, 27.403142396559243), 'schan': (6.151054506909903,), 'compat': (9.463034194514687, 7.320903797822462), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.486895017095403, 29.486895017095403), 'scords_bi': (28.386787624865214, 28.386787624865214), 'schan': (5.8704965965262685,), 'compat': (8.055599063709723, 9.354162663455478), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.22497570245899, 29.22497570245899), 'scords_bi': (26.684824211764948, 26.684824211764948), 'schan': (6.198033000956637,), 'compat': (7.8198163932919895, 8.693786640228414), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (29.440470968698325, 29.440470968698325), 'scords_bi': (27.779624894466064, 27.779624894466064), 'schan': (6.395366841335447,), 'compat': (9.832230546239309, 9.497677491089208), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (30.09654608079512, 30.09654608079512), 'scords_bi': (26.84580194247022, 26.84580194247022), 'schan': (5.157697447099579,), 'compat': (9.490487794893752, 7.538987298178612), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (29.648760449239866, 29.648760449239866), 'scords_bi': (26.721103193002072, 26.721103193002072), 'schan': (6.541443842555164,), 'compat': (8.25917857915317, 9.355499800047054), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.832285199799333, 29.832285199799333), 'scords_bi': (27.678985940295195, 27.678985940295195), 'schan': (5.906161983295077,), 'compat': (8.495862965179823, 9.770047300933395), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (29.90746879622698, 29.90746879622698), 'scords_bi': (27.91537750378078, 27.91537750378078), 'schan': (4.866136740245642,), 'compat': (9.74997388034349, 9.31769818980388), 'iter_num': 2, 'gt_conf': 0.7},
 {'scords_gau': (29.621987841877814, 29.621987841877814), 'scords_bi': (27.31815668305729, 27.31815668305729), 'schan': (5.475386413913441,), 'compat': (8.492315441668687, 9.467986092596615), 'iter_num': 3, 'gt_conf': 0.7},
 {'scords_gau': (29.876756459596365, 29.876756459596365), 'scords_bi': (28.25487922672115, 28.25487922672115), 'schan': (5.282445913364638,), 'compat': (8.686906509184306, 9.201722443559863), 'iter_num': 1, 'gt_conf': 0.7},
 {'scords_gau': (29.598332622098766, 29.598332622098766), 'scords_bi': (28.48270403381002, 28.48270403381002), 'schan': (4.951847986817124,), 'compat': (8.085000952013461, 10.056590517427747), 'iter_num': 1, 'gt_conf': 0.7}]
